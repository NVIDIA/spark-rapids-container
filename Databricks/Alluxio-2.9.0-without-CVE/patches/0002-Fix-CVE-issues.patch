From 63eb687ee2dad024de40fd52b819a48b1f17f058 Mon Sep 17 00:00:00 2001
From: Chong Gao <res_life@163.com>
Date: Thu, 15 Dec 2022 18:54:13 +0800
Subject: [PATCH 2/3] Fix CVE issues

---
 assembly/client/pom.xml                       | 25 +++++++-----
 assembly/server/pom.xml                       | 22 +++++-----
 core/common/pom.xml                           |  6 ---
 .../src/main/java/alluxio/util/LogUtils.java  |  2 +-
 core/server/worker/pom.xml                    | 12 +++---
 examples/pom.xml                              |  7 ++++
 minicluster/pom.xml                           |  2 +-
 .../multi/process/MultiProcessCluster.java    | 27 +++++++++++--
 pom.xml                                       | 34 +++++++++++-----
 shaded/client/pom.xml                         | 31 ++++++++------
 shaded/hadoop/pom.xml                         | 14 +++----
 shaded/pom.xml                                |  2 +-
 table/server/pom.xml                          |  2 +-
 underfs/pom.xml                               | 40 +++++++++----------
 14 files changed, 137 insertions(+), 89 deletions(-)

diff --git a/assembly/client/pom.xml b/assembly/client/pom.xml
index 6c17c48a09..5b0ab608f2 100644
--- a/assembly/client/pom.xml
+++ b/assembly/client/pom.xml
@@ -43,24 +43,27 @@
     </dependency>
     <dependency>
       <groupId>org.alluxio</groupId>
-      <artifactId>alluxio-core-server-common</artifactId>
+      <artifactId>alluxio-examples</artifactId>
       <version>${project.version}</version>
     </dependency>
-<!--    <dependency>-->
-<!--      <groupId>org.alluxio</groupId>-->
-<!--      <artifactId>alluxio-examples</artifactId>-->
-<!--      <version>${project.version}</version>-->
-<!--    </dependency>-->
     <dependency>
       <groupId>org.alluxio</groupId>
       <artifactId>alluxio-shell</artifactId>
       <version>${project.version}</version>
     </dependency>
-<!--    <dependency>-->
-<!--      <groupId>org.alluxio</groupId>-->
-<!--      <artifactId>alluxio-stress-shell</artifactId>-->
-<!--      <version>${project.version}</version>-->
-<!--    </dependency>-->
+    <dependency>
+      <groupId>org.alluxio</groupId>
+      <artifactId>alluxio-stress-shell</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+
+    <dependency>
+      <!-- Fix CVE: https://github.com/advisories/GHSA-fv22-xp26-mm9w -->
+      <!-- hadoop common use 5.3.0 version which has CVE -->
+      <groupId>com.fasterxml.woodstox</groupId>
+      <artifactId>woodstox-core</artifactId>
+      <version>${woodstox-core.version}</version>
+    </dependency>
   </dependencies>
 
   <build>
diff --git a/assembly/server/pom.xml b/assembly/server/pom.xml
index d5a6c72d9e..9c7b87a454 100644
--- a/assembly/server/pom.xml
+++ b/assembly/server/pom.xml
@@ -46,21 +46,21 @@
       <artifactId>alluxio-core-server-worker</artifactId>
       <version>${project.version}</version>
     </dependency>
-<!--    <dependency>-->
-<!--      <groupId>org.alluxio</groupId>-->
-<!--      <artifactId>alluxio-job-client</artifactId>-->
-<!--      <version>${project.version}</version>-->
-<!--    </dependency>-->
-<!--    <dependency>-->
-<!--      <groupId>org.alluxio</groupId>-->
-<!--      <artifactId>alluxio-job-server</artifactId>-->
-<!--      <version>${project.version}</version>-->
-<!--    </dependency>-->
     <dependency>
       <groupId>org.alluxio</groupId>
-      <artifactId>alluxio-logserver</artifactId>
+      <artifactId>alluxio-job-client</artifactId>
       <version>${project.version}</version>
     </dependency>
+    <dependency>
+      <groupId>org.alluxio</groupId>
+      <artifactId>alluxio-job-server</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.alluxio</groupId>-->
+<!--      <artifactId>alluxio-logserver</artifactId>-->
+<!--      <version>${project.version}</version>-->
+<!--    </dependency>-->
   </dependencies>
 
   <build>
diff --git a/core/common/pom.xml b/core/common/pom.xml
index 4f2e3ee5f0..4ade29305b 100644
--- a/core/common/pom.xml
+++ b/core/common/pom.xml
@@ -106,12 +106,6 @@
     <dependency>
       <groupId>org.apache.zookeeper</groupId>
       <artifactId>zookeeper</artifactId>
-      <exclusions>
-        <exclusion>
-          <groupId>org.slf4j</groupId>
-          <artifactId>slf4j-log4j12</artifactId>
-        </exclusion>
-      </exclusions>
     </dependency>
     <dependency>
       <groupId>org.reflections</groupId>
diff --git a/core/common/src/main/java/alluxio/util/LogUtils.java b/core/common/src/main/java/alluxio/util/LogUtils.java
index 4dccdbc339..d9bf117164 100644
--- a/core/common/src/main/java/alluxio/util/LogUtils.java
+++ b/core/common/src/main/java/alluxio/util/LogUtils.java
@@ -65,7 +65,7 @@ public final class LogUtils {
           logInfo.setMessage("log is null.");
         }
       } catch (Exception e) {
-        String msg = String.format("Exception occurred when setting log level, log name %s, log level %s: ",
+        String msg = String.format("Exception occurred when setting log level, log name %s, log level %s",
             e.getMessage(), logName, level);
         logInfo.setMessage(msg);
       }
diff --git a/core/server/worker/pom.xml b/core/server/worker/pom.xml
index 01ee5ff5c4..b3efa69fe6 100644
--- a/core/server/worker/pom.xml
+++ b/core/server/worker/pom.xml
@@ -125,12 +125,12 @@
       <version>${project.version}</version>
       <scope>test</scope>
     </dependency>
-<!--    <dependency>-->
-<!--      <groupId>org.alluxio</groupId>-->
-<!--      <artifactId>alluxio-underfs-hdfs</artifactId>-->
-<!--      <version>${project.version}</version>-->
-<!--      <scope>test</scope>-->
-<!--    </dependency>-->
+    <dependency>
+      <groupId>org.alluxio</groupId>
+      <artifactId>alluxio-underfs-hdfs</artifactId>
+      <version>${project.version}</version>
+      <scope>test</scope>
+    </dependency>
   </dependencies>
 
   <build>
diff --git a/examples/pom.xml b/examples/pom.xml
index 62abe9bb8a..4cb6bb2151 100644
--- a/examples/pom.xml
+++ b/examples/pom.xml
@@ -51,6 +51,13 @@
       <groupId>org.apache.hadoop</groupId>
       <artifactId>hadoop-client</artifactId>
     </dependency>
+    <dependency>
+      <!-- Fix CVE: https://github.com/advisories/GHSA-fv22-xp26-mm9w -->
+      <!-- hadoop client/common 3.2.4/3.3.1 use woodstox-core 5.3.0 version which has CVE -->
+      <groupId>com.fasterxml.woodstox</groupId>
+      <artifactId>woodstox-core</artifactId>
+      <version>${woodstox-core.version}</version>
+    </dependency>
     <dependency>
       <groupId>org.slf4j</groupId>
       <artifactId>slf4j-api</artifactId>
diff --git a/minicluster/pom.xml b/minicluster/pom.xml
index 011622c0fc..4b234cee95 100644
--- a/minicluster/pom.xml
+++ b/minicluster/pom.xml
@@ -40,7 +40,7 @@
       <artifactId>curator-test</artifactId>
       <scope>compile</scope>
       <exclusions>
-        <!-- excludes log4j 1.2 to avoid CVE issues -->
+        <!-- excludes log4j 1.x to avoid CVE issues -->
         <exclusion>
           <groupId>log4j</groupId>
           <artifactId>log4j</artifactId>
diff --git a/minicluster/src/main/java/alluxio/multi/process/MultiProcessCluster.java b/minicluster/src/main/java/alluxio/multi/process/MultiProcessCluster.java
index d4b91078aa..37a5e2a83f 100644
--- a/minicluster/src/main/java/alluxio/multi/process/MultiProcessCluster.java
+++ b/minicluster/src/main/java/alluxio/multi/process/MultiProcessCluster.java
@@ -54,8 +54,10 @@ import net.bytebuddy.utility.RandomString;
 import org.apache.commons.io.Charsets;
 import org.apache.commons.io.FileUtils;
 import org.apache.curator.test.TestingServer;
-import org.apache.log4j.Level;
-import org.apache.log4j.LogManager;
+import org.apache.logging.log4j.Level;
+import org.apache.logging.log4j.LogManager;
+import org.apache.logging.log4j.core.LoggerContext;
+import org.apache.logging.log4j.core.config.LoggerConfig;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -139,7 +141,26 @@ public final class MultiProcessCluster {
       Map<Integer, Map<PropertyKey, String>> workerProperties, int numMasters, int numWorkers,
       String clusterName, boolean noFormat,
       List<PortCoordination.ReservedPort> ports) {
-    LogManager.getLogger(MultiProcessCluster.class).setLevel(Level.DEBUG);
+
+    String logName = MultiProcessCluster.class.getName();
+    String logLevel = "DEBUG";
+    try {
+      LoggerContext ctx = (LoggerContext) (LogManager.getContext(false));
+      org.apache.logging.log4j.core.config.Configuration config = ctx.getConfiguration();
+      LoggerConfig loggerConfig = config.getLoggerConfig(logName);
+      if (loggerConfig != null) {
+        Level toLevel = Level.getLevel(logLevel);
+        loggerConfig.setLevel(toLevel);
+        ctx.updateLoggers();
+      } else {
+        String msg = String.format("Logger %s is null.", logName);
+        throw new RuntimeException(msg);
+      }
+    } catch (Exception e) {
+      String msg = String.format("Exception occurred when setting log level, log name %s, log level %s",
+          e.getMessage(), logName, logLevel);
+      throw new RuntimeException(msg);
+    }
 
     Preconditions.checkState(
         ports.size() >= numMasters * PORTS_PER_MASTER + numWorkers * PORTS_PER_WORKER,
diff --git a/pom.xml b/pom.xml
index cadd44845d..3ff234fd68 100644
--- a/pom.xml
+++ b/pom.xml
@@ -169,22 +169,23 @@
     <libcephfs.version>0.0.1</libcephfs.version>
     <jnr-fuse.version>0.5.5</jnr-fuse.version>
     <kerby.version>1.0.1</kerby.version>
+    <woodstox-core.version>5.4.0</woodstox-core.version>
   </properties>
 
   <modules>
     <module>assembly</module>
     <module>core</module>
-<!--    <module>examples</module>-->
-<!--    <module>integration</module>-->
+    <module>examples</module>
+    <module>integration</module>
 <!--    <module>logserver</module>-->
-<!--    <module>microbench</module>-->
-<!--    <module>minicluster</module>-->
-<!--    <module>job</module>-->
+    <module>microbench</module>
+    <module>minicluster</module>
+    <module>job</module>
     <module>shaded</module>
     <module>shell</module>
-<!--    <module>stress</module>-->
+    <module>stress</module>
     <module>table</module>
-<!--    <module>tests</module>-->
+    <module>tests</module>
     <module>underfs</module>
     <module>webui</module>
   </modules>
@@ -473,10 +474,21 @@
             <artifactId>servlet-api</artifactId>
           </exclusion>
           <exclusion>
-            <!-- excludes log4j 1.2 to avoid CVE issues -->
+            <!-- excludes log4j 1.x to avoid CVE issues -->
             <groupId>log4j</groupId>
             <artifactId>log4j</artifactId>
           </exclusion>
+          <exclusion>
+            <!-- excludes log4j 1.x to avoid CVE issues -->
+            <groupId>ch.qos.reload4j</groupId>
+            <artifactId>reload4j</artifactId>
+          </exclusion>
+          <exclusion>
+            <!-- excludes log4j 1.x to avoid CVE issues -->
+            <!-- StaticLoggerBinder class refer to log4j 1.x org.apache.log4j.Level -->
+            <groupId>org.slf4j</groupId>
+            <artifactId>slf4j-reload4j</artifactId>
+          </exclusion>
         </exclusions>
       </dependency>
       <dependency>
@@ -587,10 +599,14 @@
         <version>3.5.5</version>
         <exclusions>
           <exclusion>
-            <!-- excludes log4j 1.2 to avoid CVE issues -->
+            <!-- excludes log4j 1.x to avoid CVE issues -->
             <groupId>log4j</groupId>
             <artifactId>log4j</artifactId>
           </exclusion>
+            <exclusion>
+              <groupId>org.slf4j</groupId>
+              <artifactId>slf4j-log4j12</artifactId>
+            </exclusion>
         </exclusions>
       </dependency>
       <dependency>
diff --git a/shaded/client/pom.xml b/shaded/client/pom.xml
index 9962f71a0c..b077fda070 100644
--- a/shaded/client/pom.xml
+++ b/shaded/client/pom.xml
@@ -38,25 +38,25 @@
       <groupId>org.apache.hadoop</groupId>
       <artifactId>hadoop-client</artifactId>
       <scope>provided</scope>
-      <exclusions>
-        <exclusion>
-          <groupId>com.fasterxml.woodstox</groupId>
-          <artifactId>woodstox-core</artifactId>
-        </exclusion>
-      </exclusions>
     </dependency>
     <dependency>
       <groupId>org.rocksdb</groupId>
       <artifactId>rocksdbjni</artifactId>
       <scope>runtime</scope>
     </dependency>
+    <!-- Runtime logging dependencies -->
+    <dependency>
+      <groupId>org.slf4j</groupId>
+      <artifactId>slf4j-api</artifactId>
+      <scope>runtime</scope>
+    </dependency>
     <!-- Move log4j to optional, since it is mainly used in test-->
-<!--    <dependency>-->
-<!--      <groupId>org.apache.logging.log4j</groupId>-->
-<!--      <artifactId>log4j-slf4j-impl</artifactId>-->
-<!--      <scope>runtime</scope>-->
-<!--      <optional>true</optional>-->
-<!--    </dependency>-->
+    <dependency>
+      <groupId>org.apache.logging.log4j</groupId>
+      <artifactId>log4j-slf4j-impl</artifactId>
+      <scope>runtime</scope>
+      <optional>true</optional>
+    </dependency>
     <dependency>
       <groupId>org.apache.logging.log4j</groupId>
       <artifactId>log4j-api</artifactId>
@@ -175,6 +175,13 @@
               <createDependencyReducedPom>${create.dependency.reduced.pom}</createDependencyReducedPom>
               <artifactSet>
                 <excludes>
+                  <!-- Leave slf4j unshaded so downstream users can configure logging -->
+                  <exclude>org.slf4j:*</exclude>
+                  <!-- Leave log4j unshaded so downstream users can configure logging -->
+                  <exclude>log4j:log4j</exclude>
+                  <exclude>org.apache.logging.log4j:log4j-api</exclude>
+                  <exclude>org.apache.logging.log4j:log4j-core</exclude>
+                  <exclude>org.apache.logging.log4j:log4j-slf4j-impl</exclude>
                   <exclude>org.alluxio:alluxio-microbench</exclude>
                   <exclude>org.openjdk.jmh:*</exclude>
                 </excludes>
diff --git a/shaded/hadoop/pom.xml b/shaded/hadoop/pom.xml
index 7d42b7e988..fccfba256d 100644
--- a/shaded/hadoop/pom.xml
+++ b/shaded/hadoop/pom.xml
@@ -49,11 +49,11 @@
       <artifactId>slf4j-api</artifactId>
       <scope>provided</scope>
     </dependency>
-<!--    <dependency>-->
-<!--      <groupId>org.apache.logging.log4j</groupId>-->
-<!--      <artifactId>log4j-slf4j-impl</artifactId>-->
-<!--      <scope>provided</scope>-->
-<!--    </dependency>-->
+    <dependency>
+      <groupId>org.apache.logging.log4j</groupId>
+      <artifactId>log4j-slf4j-impl</artifactId>
+      <scope>provided</scope>
+    </dependency>
   </dependencies>
 
   <profiles>
@@ -81,7 +81,7 @@
           <version>${ufs.hadoop.version}</version>
           <exclusions>
             <exclusion>
-              <!-- excludes log4j 1.2 to avoid CVE issues -->
+              <!-- excludes log4j 1.x to avoid CVE issues -->
               <groupId>log4j</groupId>
               <artifactId>log4j</artifactId>
             </exclusion>
@@ -114,7 +114,7 @@
           <version>${ufs.hadoop.version}</version>
           <exclusions>
             <exclusion>
-              <!-- excludes log4j 1.2 to avoid CVE issues -->
+              <!-- excludes log4j 1.x to avoid CVE issues -->
               <groupId>log4j</groupId>
               <artifactId>log4j</artifactId>
             </exclusion>
diff --git a/shaded/pom.xml b/shaded/pom.xml
index e776c40cc9..5fef3a24d6 100644
--- a/shaded/pom.xml
+++ b/shaded/pom.xml
@@ -24,7 +24,7 @@
 
   <modules>
     <module>client</module>
-<!--    <module>hadoop</module>-->
+    <module>hadoop</module>
   </modules>
 
   <properties>
diff --git a/table/server/pom.xml b/table/server/pom.xml
index 5084439d4a..f980daf497 100644
--- a/table/server/pom.xml
+++ b/table/server/pom.xml
@@ -25,7 +25,7 @@
   <modules>
     <module>common</module>
     <module>master</module>
-<!--    <module>underdb</module>-->
+    <module>underdb</module>
   </modules>
 
   <properties>
diff --git a/underfs/pom.xml b/underfs/pom.xml
index 88fc7c3775..ea381b4e7f 100755
--- a/underfs/pom.xml
+++ b/underfs/pom.xml
@@ -23,23 +23,23 @@
   <description>Parent POM for different implementations of Alluxio under file system</description>
 
   <modules>
-<!--    <module>abfs</module>-->
-<!--    <module>adl</module>-->
-<!--    <module>cephfs</module>-->
-<!--    <module>cephfs-hadoop</module>-->
-<!--    <module>cos</module>-->
-<!--    <module>cosn</module>-->
-<!--    <module>gcs</module>-->
-<!--    <module>hdfs</module>-->
-<!--    <module>kodo</module>-->
+    <module>abfs</module>
+    <module>adl</module>
+    <module>cephfs</module>
+    <module>cephfs-hadoop</module>
+    <module>cos</module>
+    <module>cosn</module>
+    <module>gcs</module>
+    <module>hdfs</module>
+    <module>kodo</module>
     <module>local</module>
-<!--    <module>oss</module>-->
-<!--    <module>ozone</module>-->
+    <module>oss</module>
+    <module>ozone</module>
     <module>s3a</module>
-<!--    <module>swift</module>-->
-<!--    <module>wasb</module>-->
-<!--    <module>web</module>-->
-<!--    <module>obs</module>-->
+    <module>swift</module>
+    <module>wasb</module>
+    <module>web</module>
+    <module>obs</module>
   </modules>
 
   <properties>
@@ -71,11 +71,11 @@
       <artifactId>slf4j-api</artifactId>
       <scope>provided</scope>
     </dependency>
-<!--    <dependency>-->
-<!--      <groupId>org.apache.logging.log4j</groupId>-->
-<!--      <artifactId>log4j-slf4j-impl</artifactId>-->
-<!--      <scope>provided</scope>-->
-<!--    </dependency>-->
+    <dependency>
+      <groupId>org.apache.logging.log4j</groupId>
+      <artifactId>log4j-slf4j-impl</artifactId>
+      <scope>provided</scope>
+    </dependency>
   </dependencies>
 
   <build>
-- 
2.25.1

