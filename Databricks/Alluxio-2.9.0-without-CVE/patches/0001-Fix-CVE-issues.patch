From 145ad0190c7781867848c5de5d98b361bf6fb43d Mon Sep 17 00:00:00 2001
From: Chong Gao <res_life@163.com>
Date: Fri, 9 Dec 2022 09:49:40 +0800
Subject: [PATCH 1/3] Fix CVE issues

Signed-off-by: Chong Gao <res_life@163.com>
---
 assembly/client/pom.xml                       |  17 +--
 assembly/server/pom.xml                       |  20 ++--
 conf/log4j2-master.properties                 |  31 ++++++
 conf/log4j2-worker.properties                 |  31 ++++++
 core/client/hdfs/pom.xml                      |  20 ++++
 core/common/pom.xml                           |   6 ++
 .../java/alluxio/AlluxioRemoteLogFilter.java  |  96 -----------------
 .../src/main/java/alluxio/util/LogUtils.java  | 101 ++++++------------
 core/server/worker/pom.xml                    |  12 +--
 integration/tools/hms/pom.xml                 |   8 +-
 minicluster/pom.xml                           |   7 ++
 pom.xml                                       |  59 ++++++----
 shaded/client/pom.xml                         |  40 +++----
 shaded/hadoop/pom.xml                         |  24 ++++-
 shaded/pom.xml                                |   2 +-
 table/server/pom.xml                          |   2 +-
 table/server/underdb/glue/pom.xml             |   4 +
 table/server/underdb/hive/pom.xml             |   4 +
 underfs/cephfs-hadoop/pom.xml                 |   6 ++
 underfs/pom.xml                               |  40 +++----
 20 files changed, 261 insertions(+), 269 deletions(-)
 create mode 100644 conf/log4j2-master.properties
 create mode 100644 conf/log4j2-worker.properties
 delete mode 100644 core/common/src/main/java/alluxio/AlluxioRemoteLogFilter.java

diff --git a/assembly/client/pom.xml b/assembly/client/pom.xml
index 984d7ab54f..6c17c48a09 100644
--- a/assembly/client/pom.xml
+++ b/assembly/client/pom.xml
@@ -43,19 +43,24 @@
     </dependency>
     <dependency>
       <groupId>org.alluxio</groupId>
-      <artifactId>alluxio-examples</artifactId>
+      <artifactId>alluxio-core-server-common</artifactId>
       <version>${project.version}</version>
     </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.alluxio</groupId>-->
+<!--      <artifactId>alluxio-examples</artifactId>-->
+<!--      <version>${project.version}</version>-->
+<!--    </dependency>-->
     <dependency>
       <groupId>org.alluxio</groupId>
       <artifactId>alluxio-shell</artifactId>
       <version>${project.version}</version>
     </dependency>
-    <dependency>
-      <groupId>org.alluxio</groupId>
-      <artifactId>alluxio-stress-shell</artifactId>
-      <version>${project.version}</version>
-    </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.alluxio</groupId>-->
+<!--      <artifactId>alluxio-stress-shell</artifactId>-->
+<!--      <version>${project.version}</version>-->
+<!--    </dependency>-->
   </dependencies>
 
   <build>
diff --git a/assembly/server/pom.xml b/assembly/server/pom.xml
index 58ab0769bf..d5a6c72d9e 100644
--- a/assembly/server/pom.xml
+++ b/assembly/server/pom.xml
@@ -46,16 +46,16 @@
       <artifactId>alluxio-core-server-worker</artifactId>
       <version>${project.version}</version>
     </dependency>
-    <dependency>
-      <groupId>org.alluxio</groupId>
-      <artifactId>alluxio-job-client</artifactId>
-      <version>${project.version}</version>
-    </dependency>
-    <dependency>
-      <groupId>org.alluxio</groupId>
-      <artifactId>alluxio-job-server</artifactId>
-      <version>${project.version}</version>
-    </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.alluxio</groupId>-->
+<!--      <artifactId>alluxio-job-client</artifactId>-->
+<!--      <version>${project.version}</version>-->
+<!--    </dependency>-->
+<!--    <dependency>-->
+<!--      <groupId>org.alluxio</groupId>-->
+<!--      <artifactId>alluxio-job-server</artifactId>-->
+<!--      <version>${project.version}</version>-->
+<!--    </dependency>-->
     <dependency>
       <groupId>org.alluxio</groupId>
       <artifactId>alluxio-logserver</artifactId>
diff --git a/conf/log4j2-master.properties b/conf/log4j2-master.properties
new file mode 100644
index 0000000000..bbf313dabf
--- /dev/null
+++ b/conf/log4j2-master.properties
@@ -0,0 +1,31 @@
+#
+# Copyright (c) 2022, NVIDIA CORPORATION.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+# log level of log4j itself
+status=warn
+
+# rolling appender
+appender.rolling.type=File
+appender.rolling.name=fileAppender
+appender.rolling.filter.threshold.type=ThresholdFilter
+appender.rolling.filter.threshold.level=info
+appender.rolling.layout.type=PatternLayout
+appender.rolling.layout.pattern=%d{yy/MM/dd HH:mm:ss.SSS} %t %p %c{1}: %m%n
+appender.rolling.append=true
+appender.rolling.fileName=/opt/alluxio-2.9.0/logs/master.log
+
+rootLogger.level=info
+rootLogger.appenderRef.rolling.ref=fileAppender
diff --git a/conf/log4j2-worker.properties b/conf/log4j2-worker.properties
new file mode 100644
index 0000000000..f0d84846e5
--- /dev/null
+++ b/conf/log4j2-worker.properties
@@ -0,0 +1,31 @@
+#
+# Copyright (c) 2022, NVIDIA CORPORATION.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+# log level of log4j itself
+status=warn
+
+# rolling appender
+appender.rolling.type=File
+appender.rolling.name=fileAppender
+appender.rolling.filter.threshold.type=ThresholdFilter
+appender.rolling.filter.threshold.level=info
+appender.rolling.layout.type=PatternLayout
+appender.rolling.layout.pattern=%d{yy/MM/dd HH:mm:ss.SSS} %t %p %c{1}: %m%n
+appender.rolling.append=true
+appender.rolling.fileName=/opt/alluxio-2.9.0/logs/worker.log
+
+rootLogger.level=info
+rootLogger.appenderRef.rolling.ref=fileAppender
diff --git a/core/client/hdfs/pom.xml b/core/client/hdfs/pom.xml
index 14a0e56a0d..f73f290482 100644
--- a/core/client/hdfs/pom.xml
+++ b/core/client/hdfs/pom.xml
@@ -38,6 +38,16 @@
     <dependency>
       <groupId>org.apache.hadoop</groupId>
       <artifactId>hadoop-client</artifactId>
+      <exclusions>
+        <exclusion>
+          <groupId>net.minidev</groupId>
+          <artifactId>json-smart</artifactId>
+        </exclusion>
+        <exclusion>
+          <groupId>com.fasterxml.woodstox</groupId>
+          <artifactId>woodstox-core</artifactId>
+        </exclusion>
+      </exclusions>
     </dependency>
 
     <!-- Internal dependencies -->
@@ -50,6 +60,16 @@
       <groupId>org.alluxio</groupId>
       <artifactId>alluxio-core-common</artifactId>
       <version>${project.version}</version>
+      <exclusions>
+        <exclusion>
+          <groupId>net.minidev</groupId>
+          <artifactId>json-smart</artifactId>
+        </exclusion>
+        <exclusion>
+          <groupId>com.fasterxml.woodstox</groupId>
+          <artifactId>woodstox-core</artifactId>
+        </exclusion>
+      </exclusions>
     </dependency>
     <dependency>
       <groupId>org.alluxio</groupId>
diff --git a/core/common/pom.xml b/core/common/pom.xml
index 4ade29305b..4f2e3ee5f0 100644
--- a/core/common/pom.xml
+++ b/core/common/pom.xml
@@ -106,6 +106,12 @@
     <dependency>
       <groupId>org.apache.zookeeper</groupId>
       <artifactId>zookeeper</artifactId>
+      <exclusions>
+        <exclusion>
+          <groupId>org.slf4j</groupId>
+          <artifactId>slf4j-log4j12</artifactId>
+        </exclusion>
+      </exclusions>
     </dependency>
     <dependency>
       <groupId>org.reflections</groupId>
diff --git a/core/common/src/main/java/alluxio/AlluxioRemoteLogFilter.java b/core/common/src/main/java/alluxio/AlluxioRemoteLogFilter.java
deleted file mode 100644
index da5e16a544..0000000000
--- a/core/common/src/main/java/alluxio/AlluxioRemoteLogFilter.java
+++ /dev/null
@@ -1,96 +0,0 @@
-/*
- * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0
- * (the "License"). You may not use this work except in compliance with the License, which is
- * available at www.apache.org/licenses/LICENSE-2.0
- *
- * This software is distributed on an "AS IS" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
- * either express or implied, as more fully set forth in the License.
- *
- * See the NOTICE file distributed with this work for information regarding copyright ownership.
- */
-
-package alluxio;
-
-import org.apache.log4j.MDC;
-import org.apache.log4j.spi.Filter;
-import org.apache.log4j.spi.LoggingEvent;
-
-/**
- * Thin filter to add MDC information to {@link LoggingEvent}. Remote log server can read
- * {@link org.apache.log4j.spi.LoggingEvent} off {@link java.net.Socket} and retrieve the
- * MDC information. In this case the MDC information is the name of the log4j appender.
- * Remote log server then uses this appender to log messages. The implementation of this
- * class is similar to that of {@link org.apache.log4j.varia.StringMatchFilter}.
- */
-public class AlluxioRemoteLogFilter extends Filter {
-  /** Name (Key) of the MDC info. */
-  public static final String REMOTE_LOG_MDC_PROCESS_TYPE_KEY = "ProcessType";
-
-  /**
-   * @deprecated Option name to configure this {@link AlluxioRemoteLogFilter}
-   * in log4j.properties.
-   */
-  @Deprecated
-  public static final String PROCESS_TYPE_OPTION = "ProcessType";
-
-  /** Type of the process generating this log message. */
-  private String mProcessType;
-
-  /**
-   * @deprecated Gets the option strings.
-   * @return option strings as an array
-   */
-  @Deprecated
-  public String[] getOptionStrings() {
-    return new String[] {PROCESS_TYPE_OPTION};
-  }
-
-  /**
-   * @deprecated Sets option value use key=value format. The log4j.properties file uses this
-   * to set options. See the log4j.properties for more details.
-   *
-   * @param key key (name) of the option
-   * @param value value of the option
-   */
-  @Deprecated
-  public void setOption(String key, String value) {
-    if (key.equalsIgnoreCase(PROCESS_TYPE_OPTION)) {
-      mProcessType = value;
-    }
-  }
-
-  /**
-   * Sets {@code mProcessType} to be the type of the process generating this log message.
-   *
-   * Log4j parses log4j.properties, extracting the Java class that corresponds to the filter.
-   * In this case, the Java class is {@link AlluxioRemoteLogFilter}.
-   * Log4j also extracts option information as a key-value pair, e.g.
-   * "ProcessType" : "MASTER". Then log4j invokes the {@link #setProcessType(String)}
-   * method to set the value of {@link #mProcessType}.
-   *
-   * @param processType name of the log appender
-   */
-  public void setProcessType(String processType) {
-    mProcessType = processType;
-  }
-
-  /**
-   * Retrieves the string representation of process type.
-   *
-   * This method can potentially be called by log4j reflectively. Even if currently log4j
-   * does not call it, it is possible to be called in the future. Therefore, to be
-   * consistent with {@link org.apache.log4j.varia.StringMatchFilter}, we should prevent
-   * this method from been removed.
-   *
-   * @return the name of the log appender
-   */
-  public String getProcessType() {
-    return mProcessType;
-  }
-
-  @Override
-  public int decide(LoggingEvent event) {
-    MDC.put(REMOTE_LOG_MDC_PROCESS_TYPE_KEY, mProcessType);
-    return ACCEPT;
-  }
-}
diff --git a/core/common/src/main/java/alluxio/util/LogUtils.java b/core/common/src/main/java/alluxio/util/LogUtils.java
index 2124efcc11..4dccdbc339 100644
--- a/core/common/src/main/java/alluxio/util/LogUtils.java
+++ b/core/common/src/main/java/alluxio/util/LogUtils.java
@@ -12,22 +12,18 @@
 package alluxio.util;
 
 import alluxio.wire.LogInfo;
-
 import org.apache.commons.lang3.StringUtils;
-import org.apache.commons.logging.Log;
-import org.apache.commons.logging.LogFactory;
-import org.apache.commons.logging.impl.Jdk14Logger;
-import org.apache.commons.logging.impl.Log4JLogger;
-import org.apache.log4j.Category;
+import org.apache.logging.log4j.Level;
+import org.apache.logging.log4j.LogManager;
+import org.apache.logging.log4j.core.LoggerContext;
+import org.apache.logging.log4j.core.config.Configuration;
+import org.apache.logging.log4j.core.config.LoggerConfig;
 import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-import org.slf4j.impl.Log4jLoggerAdapter;
 
+import javax.annotation.concurrent.ThreadSafe;
 import java.io.IOException;
-import java.lang.reflect.Field;
 import java.util.Arrays;
 import java.util.stream.Collectors;
-import javax.annotation.concurrent.ThreadSafe;
 
 /**
  * Utility methods for working with log.
@@ -48,73 +44,36 @@ public final class LogUtils {
    * @throws IOException if an I/O error occurs
    */
   public static LogInfo setLogLevel(String logName, String level) throws IOException {
-    LogInfo result = new LogInfo();
+    LogInfo logInfo = new LogInfo();
     if (StringUtils.isNotBlank(logName)) {
-      result.setLogName(logName);
-      Log log = LogFactory.getLog(logName);
-      Logger logger = LoggerFactory.getLogger(logName);
-      if (log instanceof Log4JLogger) {
-        process(((Log4JLogger) log).getLogger(), level, result);
-      } else if (log instanceof Jdk14Logger) {
-        process(((Jdk14Logger) log).getLogger(), level, result);
-      } else if (logger instanceof Log4jLoggerAdapter) {
-        try {
-          Field field = Log4jLoggerAdapter.class.getDeclaredField("logger");
-          field.setAccessible(true);
-          org.apache.log4j.Logger log4jLogger = (org.apache.log4j.Logger) field.get(logger);
-          process(log4jLogger, level, result);
-        } catch (NoSuchFieldException | IllegalAccessException e) {
-          result.setMessage(e.getMessage());
+      try {
+        LoggerContext ctx = (LoggerContext) (LogManager.getContext(false));
+        Configuration config = ctx.getConfiguration();
+        LoggerConfig loggerConfig = config.getLoggerConfig(logName);
+        if (loggerConfig != null) {
+          Level toLevel = Level.getLevel(level.toUpperCase());
+          if (toLevel != null) {
+            loggerConfig.setLevel(toLevel);
+            Level originLevel = loggerConfig.getLevel();
+            ctx.updateLoggers();
+            logInfo.setLevel(originLevel.toString());
+            logInfo.setMessage("Setting Level to " + toLevel);
+          } else {
+            logInfo.setMessage("Bad level : " + level);
+          }
+        } else {
+          logInfo.setMessage("log is null.");
         }
-      } else {
-        result.setMessage("Sorry, " + log.getClass() + " not supported.");
+      } catch (Exception e) {
+        String msg = String.format("Exception occurred when setting log level, log name %s, log level %s: ",
+            e.getMessage(), logName, level);
+        logInfo.setMessage(msg);
       }
     } else {
-      result.setMessage("Please specify a correct logName.");
+      logInfo.setMessage("Please specify a correct logName.");
     }
-    return result;
-  }
 
-  private static void process(org.apache.log4j.Logger log, String level, LogInfo result)
-      throws IOException {
-    if (log == null) {
-      result.setMessage("log is null.");
-      return;
-    }
-    if (level != null) {
-      if (!level.equals(org.apache.log4j.Level.toLevel(level).toString())) {
-        result.setMessage("Bad level : " + level);
-      } else {
-        log.setLevel(org.apache.log4j.Level.toLevel(level));
-        result.setMessage("Setting Level to " + level);
-      }
-    }
-    org.apache.log4j.Level lev = null;
-    Category category = log;
-    while ((category != null) && ((lev = category.getLevel()) == null)) {
-      category = category.getParent();
-    }
-    if (lev != null) {
-      result.setLevel(lev.toString());
-    }
-  }
-
-  private static void process(java.util.logging.Logger log, String level, LogInfo result) throws
-      IOException {
-    if (log == null) {
-      result.setMessage("log is null.");
-      return;
-    }
-    if (level != null) {
-      log.setLevel(java.util.logging.Level.parse(level));
-      result.setMessage("Setting Level to " + level);
-    }
-
-    java.util.logging.Level lev;
-    while ((lev = log.getLevel()) == null) {
-      log = log.getParent();
-    }
-    result.setLevel(lev.toString());
+    return logInfo;
   }
 
   /**
diff --git a/core/server/worker/pom.xml b/core/server/worker/pom.xml
index b3efa69fe6..01ee5ff5c4 100644
--- a/core/server/worker/pom.xml
+++ b/core/server/worker/pom.xml
@@ -125,12 +125,12 @@
       <version>${project.version}</version>
       <scope>test</scope>
     </dependency>
-    <dependency>
-      <groupId>org.alluxio</groupId>
-      <artifactId>alluxio-underfs-hdfs</artifactId>
-      <version>${project.version}</version>
-      <scope>test</scope>
-    </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.alluxio</groupId>-->
+<!--      <artifactId>alluxio-underfs-hdfs</artifactId>-->
+<!--      <version>${project.version}</version>-->
+<!--      <scope>test</scope>-->
+<!--    </dependency>-->
   </dependencies>
 
   <build>
diff --git a/integration/tools/hms/pom.xml b/integration/tools/hms/pom.xml
index 2634d1b89e..d3c7c83a42 100644
--- a/integration/tools/hms/pom.xml
+++ b/integration/tools/hms/pom.xml
@@ -56,10 +56,6 @@
           <artifactId>protobuf-java</artifactId>
         </exclusion>
         <!-- Remove logging dependencies -->
-        <exclusion>
-          <groupId>commons-logging</groupId>
-          <artifactId>commons-logging</artifactId>
-        </exclusion>
         <exclusion>
           <groupId>org.apache.logging.log4j</groupId>
           <artifactId>log4j</artifactId>
@@ -92,6 +88,10 @@
            <groupId>jdk.tools</groupId>
            <artifactId>jdk.tools</artifactId>
         </exclusion>
+        <exclusion>
+          <groupId>log4j</groupId>
+          <artifactId>log4j</artifactId>
+        </exclusion>
       </exclusions>
     </dependency>
   </dependencies>
diff --git a/minicluster/pom.xml b/minicluster/pom.xml
index ace881c158..011622c0fc 100644
--- a/minicluster/pom.xml
+++ b/minicluster/pom.xml
@@ -39,6 +39,13 @@
       <groupId>org.apache.curator</groupId>
       <artifactId>curator-test</artifactId>
       <scope>compile</scope>
+      <exclusions>
+        <!-- excludes log4j 1.2 to avoid CVE issues -->
+        <exclusion>
+          <groupId>log4j</groupId>
+          <artifactId>log4j</artifactId>
+        </exclusion>
+      </exclusions>
     </dependency>
     <dependency>
       <groupId>junit</groupId>
diff --git a/pom.xml b/pom.xml
index 57608ffe4e..cadd44845d 100644
--- a/pom.xml
+++ b/pom.xml
@@ -124,7 +124,7 @@
   <properties>
     <argLine />
     <apache.curator.version>4.2.0</apache.curator.version>
-    <aws.amazonaws.version>1.11.815</aws.amazonaws.version>
+    <aws.amazonaws.version>1.12.261</aws.amazonaws.version>
     <build.path>build</build.path>
     <catalyst.version>1.2.1</catalyst.version>
     <glusterfs-hadoop.version>2.3.13</glusterfs-hadoop.version>
@@ -137,9 +137,9 @@
     <java.version>1.8</java.version>
     <jaxb.version>2.3.3</jaxb.version>
     <jersey.version>2.34</jersey.version>
-    <jetty.version>9.4.46.v20220331</jetty.version>
+    <jetty.version>9.4.48.v20220622</jetty.version>
     <junit.version>4.13.1</junit.version>
-    <log4j.version>2.17.1</log4j.version>
+    <log4j.version>2.17.2</log4j.version>
     <maven.version>3.3.9</maven.version>
     <metrics.version>4.1.11</metrics.version>
     <mockito.version>3.4.4</mockito.version>
@@ -149,10 +149,10 @@
     <prometheus.version>0.8.0</prometheus.version>
     <guava.version>31.0.1-jre</guava.version>
     <parquet.version>1.11.0</parquet.version>
-    <protobuf.version>3.19.2</protobuf.version>
+    <protobuf.version>3.19.6</protobuf.version>
     <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
-    <slf4j.version>1.7.30</slf4j.version>
-    <jackson.version>2.13.3</jackson.version>
+    <slf4j.version>1.7.32</slf4j.version>
+    <jackson.version>2.14.0</jackson.version>
     <hadoop-cos.version>3.1.0-5.8.5</hadoop-cos.version>
     <cos_api.version>5.6.19</cos_api.version>
     <surefire.forkCount>2</surefire.forkCount>
@@ -174,17 +174,17 @@
   <modules>
     <module>assembly</module>
     <module>core</module>
-    <module>examples</module>
-    <module>integration</module>
-    <module>logserver</module>
-    <module>microbench</module>
-    <module>minicluster</module>
-    <module>job</module>
+<!--    <module>examples</module>-->
+<!--    <module>integration</module>-->
+<!--    <module>logserver</module>-->
+<!--    <module>microbench</module>-->
+<!--    <module>minicluster</module>-->
+<!--    <module>job</module>-->
     <module>shaded</module>
     <module>shell</module>
-    <module>stress</module>
+<!--    <module>stress</module>-->
     <module>table</module>
-    <module>tests</module>
+<!--    <module>tests</module>-->
     <module>underfs</module>
     <module>webui</module>
   </modules>
@@ -308,11 +308,6 @@
         <artifactId>commons-io</artifactId>
         <version>2.7</version>
       </dependency>
-      <dependency>
-        <groupId>commons-logging</groupId>
-        <artifactId>commons-logging</artifactId>
-        <version>1.2</version>
-      </dependency>
       <dependency>
         <groupId>io.dropwizard.metrics</groupId>
         <artifactId>metrics-core</artifactId>
@@ -477,6 +472,11 @@
             <groupId>javax.servlet</groupId>
             <artifactId>servlet-api</artifactId>
           </exclusion>
+          <exclusion>
+            <!-- excludes log4j 1.2 to avoid CVE issues -->
+            <groupId>log4j</groupId>
+            <artifactId>log4j</artifactId>
+          </exclusion>
         </exclusions>
       </dependency>
       <dependency>
@@ -585,6 +585,13 @@
         <groupId>org.apache.zookeeper</groupId>
         <artifactId>zookeeper</artifactId>
         <version>3.5.5</version>
+        <exclusions>
+          <exclusion>
+            <!-- excludes log4j 1.2 to avoid CVE issues -->
+            <groupId>log4j</groupId>
+            <artifactId>log4j</artifactId>
+          </exclusion>
+        </exclusions>
       </dependency>
       <dependency>
         <groupId>org.eclipse.jetty</groupId>
@@ -688,6 +695,12 @@
         <artifactId>log4j-slf4j-impl</artifactId>
         <version>${log4j.version}</version>
       </dependency>
+<!--      <dependency>-->
+<!--        <groupId>org.apache.logging.log4j</groupId>-->
+<!--        <artifactId>log4j-1.2-api</artifactId>-->
+<!--        <version>${log4j.version}</version>-->
+<!--      </dependency>-->
+
       <dependency>
         <groupId>org.apache.kerby</groupId>
         <artifactId>kerby-util</artifactId>
@@ -808,10 +821,10 @@
       <groupId>org.apache.logging.log4j</groupId>
       <artifactId>log4j-slf4j-impl</artifactId>
     </dependency>
-    <dependency>
-      <groupId>org.slf4j</groupId>
-      <artifactId>slf4j-api</artifactId>
-    </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.apache.logging.log4j</groupId>-->
+<!--      <artifactId>log4j-1.2-api</artifactId>-->
+<!--    </dependency>-->
 
     <!-- Dependencies in the test scope. -->
     <dependency>
diff --git a/shaded/client/pom.xml b/shaded/client/pom.xml
index 4ced4d4152..9962f71a0c 100644
--- a/shaded/client/pom.xml
+++ b/shaded/client/pom.xml
@@ -38,30 +38,25 @@
       <groupId>org.apache.hadoop</groupId>
       <artifactId>hadoop-client</artifactId>
       <scope>provided</scope>
+      <exclusions>
+        <exclusion>
+          <groupId>com.fasterxml.woodstox</groupId>
+          <artifactId>woodstox-core</artifactId>
+        </exclusion>
+      </exclusions>
     </dependency>
     <dependency>
       <groupId>org.rocksdb</groupId>
       <artifactId>rocksdbjni</artifactId>
       <scope>runtime</scope>
     </dependency>
-    <!-- Runtime logging dependencies -->
-    <dependency>
-      <groupId>org.slf4j</groupId>
-      <artifactId>slf4j-api</artifactId>
-      <scope>runtime</scope>
-    </dependency>
-    <dependency>
-      <groupId>commons-logging</groupId>
-      <artifactId>commons-logging</artifactId>
-      <scope>runtime</scope>
-    </dependency>
     <!-- Move log4j to optional, since it is mainly used in test-->
-    <dependency>
-      <groupId>org.apache.logging.log4j</groupId>
-      <artifactId>log4j-slf4j-impl</artifactId>
-      <scope>runtime</scope>
-      <optional>true</optional>
-    </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.apache.logging.log4j</groupId>-->
+<!--      <artifactId>log4j-slf4j-impl</artifactId>-->
+<!--      <scope>runtime</scope>-->
+<!--      <optional>true</optional>-->
+<!--    </dependency>-->
     <dependency>
       <groupId>org.apache.logging.log4j</groupId>
       <artifactId>log4j-api</artifactId>
@@ -180,15 +175,6 @@
               <createDependencyReducedPom>${create.dependency.reduced.pom}</createDependencyReducedPom>
               <artifactSet>
                 <excludes>
-                  <!-- Leave slf4j unshaded so downstream users can configure logging -->
-                  <exclude>org.slf4j:*</exclude>
-                  <!-- Leave commons-logging unshaded so downstream users can configure logging -->
-                  <exclude>commons-logging:commons-logging</exclude>
-                  <!-- Leave log4j unshaded so downstream users can configure logging -->
-                  <exclude>log4j:log4j</exclude>
-                  <exclude>org.apache.logging.log4j:log4j-api</exclude>
-                  <exclude>org.apache.logging.log4j:log4j-core</exclude>
-                  <exclude>org.apache.logging.log4j:log4j-slf4j-impl</exclude>
                   <exclude>org.alluxio:alluxio-microbench</exclude>
                   <exclude>org.openjdk.jmh:*</exclude>
                 </excludes>
@@ -278,6 +264,8 @@
                     <!-- Exclude the logging packages-->
                     <exclude>org/slf4j/*</exclude>
                     <exclude>org/slf4j/**/*</exclude>
+                    <exclude>org/apache/logging/*</exclude>
+                    <exclude>org/apache/logging/**/*</exclude>
                     <exclude>org/apache/commons/logging/*</exclude>
                     <exclude>org/apache/commons/logging/**/*</exclude>
                     <exclude>org/apache/log4j/*</exclude>
diff --git a/shaded/hadoop/pom.xml b/shaded/hadoop/pom.xml
index 52b9c682d7..7d42b7e988 100644
--- a/shaded/hadoop/pom.xml
+++ b/shaded/hadoop/pom.xml
@@ -49,11 +49,11 @@
       <artifactId>slf4j-api</artifactId>
       <scope>provided</scope>
     </dependency>
-    <dependency>
-      <groupId>org.apache.logging.log4j</groupId>
-      <artifactId>log4j-slf4j-impl</artifactId>
-      <scope>provided</scope>
-    </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.apache.logging.log4j</groupId>-->
+<!--      <artifactId>log4j-slf4j-impl</artifactId>-->
+<!--      <scope>provided</scope>-->
+<!--    </dependency>-->
   </dependencies>
 
   <profiles>
@@ -79,6 +79,13 @@
           <groupId>org.apache.hadoop</groupId>
           <artifactId>hadoop-common</artifactId>
           <version>${ufs.hadoop.version}</version>
+          <exclusions>
+            <exclusion>
+              <!-- excludes log4j 1.2 to avoid CVE issues -->
+              <groupId>log4j</groupId>
+              <artifactId>log4j</artifactId>
+            </exclusion>
+          </exclusions>
         </dependency>
         <dependency>
           <groupId>org.apache.hadoop</groupId>
@@ -105,6 +112,13 @@
           <groupId>org.apache.hadoop</groupId>
           <artifactId>hadoop-common</artifactId>
           <version>${ufs.hadoop.version}</version>
+          <exclusions>
+            <exclusion>
+              <!-- excludes log4j 1.2 to avoid CVE issues -->
+              <groupId>log4j</groupId>
+              <artifactId>log4j</artifactId>
+            </exclusion>
+          </exclusions>
         </dependency>
         <dependency>
           <groupId>org.apache.hadoop</groupId>
diff --git a/shaded/pom.xml b/shaded/pom.xml
index 5fef3a24d6..e776c40cc9 100644
--- a/shaded/pom.xml
+++ b/shaded/pom.xml
@@ -24,7 +24,7 @@
 
   <modules>
     <module>client</module>
-    <module>hadoop</module>
+<!--    <module>hadoop</module>-->
   </modules>
 
   <properties>
diff --git a/table/server/pom.xml b/table/server/pom.xml
index f980daf497..5084439d4a 100644
--- a/table/server/pom.xml
+++ b/table/server/pom.xml
@@ -25,7 +25,7 @@
   <modules>
     <module>common</module>
     <module>master</module>
-    <module>underdb</module>
+<!--    <module>underdb</module>-->
   </modules>
 
   <properties>
diff --git a/table/server/underdb/glue/pom.xml b/table/server/underdb/glue/pom.xml
index fd496a433b..f500367a72 100644
--- a/table/server/underdb/glue/pom.xml
+++ b/table/server/underdb/glue/pom.xml
@@ -71,6 +71,10 @@
                   <groupId>com.google.protobuf</groupId>
                   <artifactId>protobuf-java</artifactId>
               </exclusion>
+              <exclusion>
+                  <groupId>log4j</groupId>
+                  <artifactId>log4j</artifactId>
+              </exclusion>
           </exclusions>
       </dependency>
   </dependencies>
diff --git a/table/server/underdb/hive/pom.xml b/table/server/underdb/hive/pom.xml
index d6e196d1be..e42cad5e0b 100644
--- a/table/server/underdb/hive/pom.xml
+++ b/table/server/underdb/hive/pom.xml
@@ -55,6 +55,10 @@
           <groupId>com.google.protobuf</groupId>
           <artifactId>protobuf-java</artifactId>
         </exclusion>
+        <exclusion>
+          <groupId>log4j</groupId>
+          <artifactId>log4j</artifactId>
+        </exclusion>
       </exclusions>
     </dependency>
 
diff --git a/underfs/cephfs-hadoop/pom.xml b/underfs/cephfs-hadoop/pom.xml
index 7f41992afc..e5f7afe92f 100644
--- a/underfs/cephfs-hadoop/pom.xml
+++ b/underfs/cephfs-hadoop/pom.xml
@@ -32,6 +32,12 @@
     <dependency>
       <groupId>io.github.opendataio</groupId>
       <artifactId>cephfs-hadoop</artifactId>
+      <exclusions>
+        <exclusion>
+          <groupId>log4j</groupId>
+          <artifactId>log4j</artifactId>
+        </exclusion>
+      </exclusions>
     </dependency>
     <!-- Internal dependencies -->
     <dependency>
diff --git a/underfs/pom.xml b/underfs/pom.xml
index ea381b4e7f..88fc7c3775 100755
--- a/underfs/pom.xml
+++ b/underfs/pom.xml
@@ -23,23 +23,23 @@
   <description>Parent POM for different implementations of Alluxio under file system</description>
 
   <modules>
-    <module>abfs</module>
-    <module>adl</module>
-    <module>cephfs</module>
-    <module>cephfs-hadoop</module>
-    <module>cos</module>
-    <module>cosn</module>
-    <module>gcs</module>
-    <module>hdfs</module>
-    <module>kodo</module>
+<!--    <module>abfs</module>-->
+<!--    <module>adl</module>-->
+<!--    <module>cephfs</module>-->
+<!--    <module>cephfs-hadoop</module>-->
+<!--    <module>cos</module>-->
+<!--    <module>cosn</module>-->
+<!--    <module>gcs</module>-->
+<!--    <module>hdfs</module>-->
+<!--    <module>kodo</module>-->
     <module>local</module>
-    <module>oss</module>
-    <module>ozone</module>
+<!--    <module>oss</module>-->
+<!--    <module>ozone</module>-->
     <module>s3a</module>
-    <module>swift</module>
-    <module>wasb</module>
-    <module>web</module>
-    <module>obs</module>
+<!--    <module>swift</module>-->
+<!--    <module>wasb</module>-->
+<!--    <module>web</module>-->
+<!--    <module>obs</module>-->
   </modules>
 
   <properties>
@@ -71,11 +71,11 @@
       <artifactId>slf4j-api</artifactId>
       <scope>provided</scope>
     </dependency>
-    <dependency>
-      <groupId>org.apache.logging.log4j</groupId>
-      <artifactId>log4j-slf4j-impl</artifactId>
-      <scope>provided</scope>
-    </dependency>
+<!--    <dependency>-->
+<!--      <groupId>org.apache.logging.log4j</groupId>-->
+<!--      <artifactId>log4j-slf4j-impl</artifactId>-->
+<!--      <scope>provided</scope>-->
+<!--    </dependency>-->
   </dependencies>
 
   <build>
-- 
2.25.1

